#!/bin/bash
set -euo pipefail

CONFIG_FILE="/etc/done.conf"
[ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"

MESSAGE="${1:-âœ… Task complete on $(hostname)}"

if [ -z "${WEBHOOK_URL:-}" ]; then
  echo "Error: WEBHOOK_URL not set in $CONFIG_FILE." >&2
  exit 1
fi

json_escape() {
  local value=$1
  value=${value//\\/\\\\}
  value=${value//\"/\\\"}
  value=${value//$'\n'/\\n}
  value=${value//$'\r'/\\r}
  value=${value//$'\t'/\\t}
  printf '%s' "$value"
}

payload=$(json_escape "$MESSAGE")
curl -fsS -H "Content-Type: application/json" \
     -X POST \
     -d "{\"content\":\"$payload\"}" \
     "$WEBHOOK_URL" >/dev/null
