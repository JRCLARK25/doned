#!/bin/bash
set -euo pipefail

expand_path() {
  local path=$1
  case "$path" in
    "~") printf '%s\n' "$HOME" ;;
    "~/"*) printf '%s\n' "${HOME}/${path#~/}" ;;
    *) printf '%s\n' "$path" ;;
  esac
}

SYSTEM_CONFIG="/etc/done.conf"
USER_CONFIG="${XDG_CONFIG_HOME:-$HOME/.config}/doned/done.conf"

if [ -n "${DONED_CONFIG:-}" ]; then
  CONFIG_FILE=$(expand_path "$DONED_CONFIG")
elif [ "$(id -u)" -eq 0 ]; then
  CONFIG_FILE="$SYSTEM_CONFIG"
elif [ -r "$SYSTEM_CONFIG" ] && [ ! -f "$USER_CONFIG" ]; then
  CONFIG_FILE="$SYSTEM_CONFIG"
else
  CONFIG_FILE="$USER_CONFIG"
fi

[ -f "$CONFIG_FILE" ] && [ -r "$CONFIG_FILE" ] && source "$CONFIG_FILE"

MESSAGE="${1:-âœ… Task complete on $(hostname)}"

if [ -z "${WEBHOOK_URL:-}" ]; then
  echo "Error: WEBHOOK_URL not set in $CONFIG_FILE." >&2
  exit 1
fi

json_escape() {
  local value=$1
  value=${value//\\/\\\\}
  value=${value//\"/\\\"}
  value=${value//$'\n'/\\n}
  value=${value//$'\r'/\\r}
  value=${value//$'\t'/\\t}
  printf '%s' "$value"
}

payload=$(json_escape "$MESSAGE")
curl -fsS -H "Content-Type: application/json" \
     -X POST \
     -d "{\"content\":\"$payload\"}" \
     "$WEBHOOK_URL" >/dev/null
